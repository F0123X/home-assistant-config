[{"id":"4df1ebb8.41e0d4","type":"tab","label":"Front Door","disabled":false,"info":""},{"id":"f777b71b.223cb8","type":"tab","label":"Lighting Automation V2","disabled":true,"info":""},{"id":"21c55085.5e8c","type":"tab","label":"Light Automation Testing","disabled":true,"info":""},{"id":"66c49aa0.fcfbf4","type":"subflow","name":"Say","info":"Input needs to be a msg payload with the two fields:\n\nmessage - What you want Sonos to say\nvolume_level - How loud do you want Sonos to say it\n\n{\n    \"message\": \"This is a sample voice command.\",\n    \"volume_level\": 0.3\n}","category":"","in":[{"x":104,"y":156,"wires":[{"id":"b68b58cc.c353b8"},{"id":"b32af84b.55e948"}]}],"out":[]},{"id":"47459c8.4133064","type":"subflow","name":"Activate LED","info":"","category":"","in":[{"x":32,"y":300,"wires":[{"id":"70b0467a.9c1f18"}]}],"out":[]},{"id":"4cf7b431.d9002c","type":"subflow","name":"Light Automation","info":"","category":"","in":[{"x":68,"y":216,"wires":[{"id":"e7463eae.39c6c"}]}],"out":[]},{"id":"6960f853.5a11b8","type":"server","z":"","name":"Home Assistant","legacy":false,"hassio":false,"rejectUnauthorizedCerts":false,"ha_boolean":"y|yes|true|on|home|open"},{"id":"7c2cc3ae.eb8bac","type":"mqtt-broker","z":"","name":"mqtt-hass","broker":"localhost","port":"1883","clientid":"nr_mqtt","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"hass/status","birthQos":"0","birthRetain":"true","birthPayload":"online","closeTopic":"hass/status","closeQos":"0","closeRetain":"true","closePayload":"offline","willTopic":"hass/status","willQos":"0","willRetain":"true","willPayload":"offline"},{"id":"e0053dc7.15d78","type":"poll-state","z":"4df1ebb8.41e0d4","name":"Poll State - Front Door Sensor","server":"6960f853.5a11b8","updateinterval":"30","outputinitially":true,"outputonchanged":true,"entity_id":"sensor.ecolink_doorwindow_sensor_access_control","state_type":"str","halt_if":"","halt_if_type":"","halt_if_compare":"is","outputs":1,"x":170,"y":80,"wires":[["7514f052.dd3b8","92c1eed7.49fc2"]]},{"id":"a0811362.5f9be","type":"template","z":"4df1ebb8.41e0d4","name":"Time Since Changed","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{{ data.timeSinceChangedMs }}","output":"str","x":450,"y":140,"wires":[["bd2a2e06.8bf43","f79a0c3b.94129"]]},{"id":"bd2a2e06.8bf43","type":"function","z":"4df1ebb8.41e0d4","name":"Greater Than 20 Seconds","func":"var greaterThan20Seconds = (Number(msg.payload) > 20000) ? \"true\":\"false\";\nvar newMsg = { payload: greaterThan20Seconds };\nreturn newMsg;","outputs":1,"noerr":0,"x":720,"y":80,"wires":[["2135ffd5.b48fc","47d3bbb5.8fd934"]]},{"id":"7514f052.dd3b8","type":"debug","z":"4df1ebb8.41e0d4","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":420,"y":80,"wires":[]},{"id":"943a56b3.ac3f78","type":"debug","z":"4df1ebb8.41e0d4","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1150,"y":80,"wires":[]},{"id":"f79a0c3b.94129","type":"debug","z":"4df1ebb8.41e0d4","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":700,"y":140,"wires":[]},{"id":"fd7196ef.a33078","type":"api-current-state","z":"4df1ebb8.41e0d4","name":"Lock State","server":"6960f853.5a11b8","outputs":1,"halt_if":"locked","override_topic":true,"entity_id":"lock.front_door_lock","override_payload":true,"x":1160,"y":130,"wires":[["75cf7ea9.539d9","6c763588.1e4e5c"]]},{"id":"2135ffd5.b48fc","type":"switch","z":"4df1ebb8.41e0d4","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"true","vt":"str"},{"t":"eq","v":"false","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":920,"y":140,"wires":[["fd7196ef.a33078","943a56b3.ac3f78"],["943a56b3.ac3f78"]]},{"id":"47d3bbb5.8fd934","type":"debug","z":"4df1ebb8.41e0d4","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":930,"y":80,"wires":[]},{"id":"75cf7ea9.539d9","type":"api-call-service","z":"4df1ebb8.41e0d4","name":"Lock Front Door","server":"6960f853.5a11b8","service_domain":"lock","service":"lock","data":"{\"entity_id\":\"lock.front_door_lock\",\"code\":\"1492\"}","mergecontext":"","x":1370,"y":130,"wires":[["a0bdf778.13ef78"]]},{"id":"92c1eed7.49fc2","type":"switch","z":"4df1ebb8.41e0d4","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"23","vt":"str"},{"t":"neq","v":"23","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":210,"y":240,"wires":[["74e4d667.953968","a0811362.5f9be","e2a1a828.c0c528"],["74e4d667.953968","5014189c.d76c38"]],"outputLabels":["Closed","Open"]},{"id":"74e4d667.953968","type":"debug","z":"4df1ebb8.41e0d4","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":390,"y":240,"wires":[]},{"id":"5014189c.d76c38","type":"template","z":"4df1ebb8.41e0d4","name":"Time Since Changed","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{{ payload.timeSinceChangedMs }}","output":"str","x":440,"y":310,"wires":[["e1a0cbae.1f2788"]]},{"id":"e1a0cbae.1f2788","type":"function","z":"4df1ebb8.41e0d4","name":"Greater Than 5 Minutes","func":"var greaterThan20Seconds = (Number(msg.payload) > 300000) ? \"true\":\"false\";\nvar newMsg = { payload: greaterThan20Seconds };\nreturn newMsg;","outputs":1,"noerr":0,"x":720,"y":310,"wires":[["70e6d4b.0da4c2c"]]},{"id":"70e6d4b.0da4c2c","type":"switch","z":"4df1ebb8.41e0d4","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"true","vt":"str"},{"t":"eq","v":"false","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":920,"y":310,"wires":[["1ae0cff7.e2fc2"],[]]},{"id":"66984497.83950c","type":"change","z":"4df1ebb8.41e0d4","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.message","pt":"msg","to":"The front door has been open for more than 5 minutes. Please shut it.","tot":"str"},{"t":"set","p":"payload.volume_level","pt":"msg","to":"0.4","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1300,"y":380,"wires":[["698493f7.e6facc","baeb0db.5d7f4f"]]},{"id":"15d68fb8.13e5","type":"mqtt in","z":"4df1ebb8.41e0d4","name":"","topic":"hass/front-door/open/warned","qos":"2","broker":"7c2cc3ae.eb8bac","x":240,"y":480,"wires":[["cf7ae423.47b108"]]},{"id":"cf7ae423.47b108","type":"change","z":"4df1ebb8.41e0d4","name":"","rules":[{"t":"set","p":"warned","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":490,"y":480,"wires":[[]]},{"id":"1ae0cff7.e2fc2","type":"switch","z":"4df1ebb8.41e0d4","name":"","property":"warned","propertyType":"flow","rules":[{"t":"eq","v":"true","vt":"str"},{"t":"eq","v":"false","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1090,"y":400,"wires":[[],["66984497.83950c"]]},{"id":"62ee123f.f8381c","type":"mqtt out","z":"4df1ebb8.41e0d4","name":"","topic":"hass/front-door/open/warned","qos":"2","retain":"true","broker":"7c2cc3ae.eb8bac","x":1770,"y":400,"wires":[]},{"id":"698493f7.e6facc","type":"change","z":"4df1ebb8.41e0d4","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"true","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1530,"y":400,"wires":[["62ee123f.f8381c"]]},{"id":"6a3e097.f3ca9f8","type":"mqtt out","z":"4df1ebb8.41e0d4","name":"","topic":"hass/front-door/open/warned","qos":"2","retain":"true","broker":"7c2cc3ae.eb8bac","x":750,"y":190,"wires":[]},{"id":"e2a1a828.c0c528","type":"change","z":"4df1ebb8.41e0d4","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"false","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":510,"y":190,"wires":[["6a3e097.f3ca9f8"]]},{"id":"6c763588.1e4e5c","type":"debug","z":"4df1ebb8.41e0d4","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1370,"y":80,"wires":[]},{"id":"a0bdf778.13ef78","type":"debug","z":"4df1ebb8.41e0d4","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1570,"y":80,"wires":[]},{"id":"87340bb9.fce648","type":"server-state-changed","z":"4df1ebb8.41e0d4","name":"Front Door Lock","server":"6960f853.5a11b8","entityidfilter":"lock.front_door_lock","entityidfiltertype":"exact","outputinitially":true,"haltifstate":"","outputs":1,"x":140,"y":580,"wires":[["573a8ad0.2fe7c4"]]},{"id":"573a8ad0.2fe7c4","type":"mqtt out","z":"4df1ebb8.41e0d4","name":"","topic":"hass/front-door/locked","qos":"0","retain":"true","broker":"7c2cc3ae.eb8bac","x":490,"y":580,"wires":[]},{"id":"b32af84b.55e948","type":"change","z":"66c49aa0.fcfbf4","name":"Handle User Input","rules":[{"t":"set","p":"message","pt":"flow","to":"payload.message","tot":"msg"},{"t":"set","p":"volume_level","pt":"flow","to":"payload.volume_level","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":246,"y":228,"wires":[["a52f4fe6.b60a9"]]},{"id":"a52f4fe6.b60a9","type":"ha-get-entities","z":"66c49aa0.fcfbf4","server":"6960f853.5a11b8","name":"Get Sonos","rules":[{"property":"entity_id","logic":"starts_with","value":"media_player","valueType":"str"},{"property":"attributes.supported_features","logic":"is","value":"64063","valueType":"num"}],"output_type":"array","output_empty_results":true,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":250,"y":276,"wires":[["1af0e21a.cfcc4e"]]},{"id":"1af0e21a.cfcc4e","type":"switch","z":"66c49aa0.fcfbf4","name":"Sonos Available?","property":"payload.length","propertyType":"msg","rules":[{"t":"neq","v":"0","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":306,"y":324,"wires":[["7c6e6987.e6c8b8"],[]],"outputLabels":["Entities were found.","No entities found."]},{"id":"7c6e6987.e6c8b8","type":"function","z":"66c49aa0.fcfbf4","name":"Define variables","func":"var entities_ids = \"\";\nvar master_entity_id = \"\";\nvar volume = flow.get(\"volume_level\")||0.1;\nvar message = flow.get(\"message\")||\"\";\nvar with_group = true;\n\nfor (let i=0; i<msg.payload.length; i++){\n    entities_ids += msg.payload[i].entity_id;\n    if (i<msg.payload.length-1) {\n        entities_ids += \",\";\n    }\n    if (i===0) {\n        master_entity_id = msg.payload[i].entity_id;\n    }\n}\n\nvar flowMsg = {\n    payload: {\n        entity_id: entities_ids,\n        master: master_entity_id,\n        volume_level: volume,\n        message: message,\n        with_group: with_group\n    }\n};\nreturn flowMsg;","outputs":1,"noerr":0,"x":488,"y":192,"wires":[["c71c0343.3e5b1"]]},{"id":"c71c0343.3e5b1","type":"change","z":"66c49aa0.fcfbf4","name":"Save variables as flow","rules":[{"t":"set","p":"data","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":532,"y":240,"wires":[["b06d8416.8ef928"]]},{"id":"b06d8416.8ef928","type":"change","z":"66c49aa0.fcfbf4","name":"Prep Sonos Snapshot","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"data.entity_id","tot":"flow"},{"t":"set","p":"payload.data.with_group","pt":"msg","to":"data.with_group","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":568,"y":288,"wires":[["2a8b4ec.af679b2"]]},{"id":"2a8b4ec.af679b2","type":"api-call-service","z":"66c49aa0.fcfbf4","name":"Sonos Snapshot","server":"6960f853.5a11b8","service_domain":"media_player","service":"sonos_snapshot","data":"","mergecontext":"","output_location":"payload","output_location_type":"msg","x":572,"y":336,"wires":[["79a16397.4e72ac"]]},{"id":"79a16397.4e72ac","type":"delay","z":"66c49aa0.fcfbf4","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":612,"y":384,"wires":[["dcf87d50.0636d"]]},{"id":"dcf87d50.0636d","type":"change","z":"66c49aa0.fcfbf4","name":"Prep Sonos Unjoin","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"data.entity_id","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":824,"y":192,"wires":[["d6318ee6.fb53b"]]},{"id":"d6318ee6.fb53b","type":"api-call-service","z":"66c49aa0.fcfbf4","name":"Sonos Unjoin","server":"6960f853.5a11b8","service_domain":"media_player","service":"sonos_unjoin","data":"","mergecontext":"","output_location":"payload","output_location_type":"msg","x":828,"y":240,"wires":[["1603ec3a.7e3194"]],"icon":"node-red/split.png"},{"id":"1603ec3a.7e3194","type":"delay","z":"66c49aa0.fcfbf4","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":840,"y":288,"wires":[["d2b4cab8.90b918"]]},{"id":"d2b4cab8.90b918","type":"change","z":"66c49aa0.fcfbf4","name":"Prep Sonos Join","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"data.entity_id","tot":"flow"},{"t":"set","p":"payload.data.master","pt":"msg","to":"data.master","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":826,"y":336,"wires":[["aa610b43.adbf58"]]},{"id":"4741d530.f5d2bc","type":"change","z":"66c49aa0.fcfbf4","name":"Prep Sonos Volume","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"data.entity_id","tot":"flow"},{"t":"set","p":"payload.data.volume_level","pt":"msg","to":"data.volume_level","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":1086,"y":192,"wires":[["4cd4595b.30d6e8"]]},{"id":"4c8ccbb3.a6b0d4","type":"change","z":"66c49aa0.fcfbf4","name":"Prep Sonos Say","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"data.entity_id","tot":"flow"},{"t":"set","p":"payload.data.message","pt":"msg","to":"data.message","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":1100,"y":336,"wires":[["bb1da51.ac62858"]]},{"id":"aa610b43.adbf58","type":"api-call-service","z":"66c49aa0.fcfbf4","name":"Sonos Join","server":"6960f853.5a11b8","service_domain":"media_player","service":"sonos_join","data":"","mergecontext":"","output_location":"payload","output_location_type":"msg","x":840,"y":384,"wires":[["4b8bf75b.80fde8"]],"icon":"node-red/join.png"},{"id":"4b8bf75b.80fde8","type":"delay","z":"66c49aa0.fcfbf4","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":852,"y":432,"wires":[["4741d530.f5d2bc"]]},{"id":"4cd4595b.30d6e8","type":"api-call-service","z":"66c49aa0.fcfbf4","name":"Set Volume","server":"6960f853.5a11b8","service_domain":"media_player","service":"volume_set","data":"","mergecontext":"","output_location":"payload","output_location_type":"msg","x":1078,"y":240,"wires":[["6f3998d1.5d3138"]]},{"id":"6f3998d1.5d3138","type":"delay","z":"66c49aa0.fcfbf4","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1078,"y":288,"wires":[["4c8ccbb3.a6b0d4"]]},{"id":"bb1da51.ac62858","type":"api-call-service","z":"66c49aa0.fcfbf4","name":"Sonos Say","server":"6960f853.5a11b8","service_domain":"tts","service":"google_translate_say","data":"","mergecontext":"","output_location":"payload","output_location_type":"msg","x":1102,"y":384,"wires":[["db06057f.41e568","22f8bed6.68f6e2"]]},{"id":"db06057f.41e568","type":"delay","z":"66c49aa0.fcfbf4","name":"","pauseType":"delay","timeout":"15","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1140,"y":432,"wires":[["39764e17.d151d2"]]},{"id":"b68b58cc.c353b8","type":"change","z":"66c49aa0.fcfbf4","name":"Set Offline","rules":[{"t":"set","p":"payload","pt":"msg","to":"offline","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":382,"y":144,"wires":[["5887cc6a.bcc694"]]},{"id":"5887cc6a.bcc694","type":"mqtt out","z":"66c49aa0.fcfbf4","name":"","topic":"hass/automation/speak/available","qos":"0","retain":"true","broker":"7c2cc3ae.eb8bac","x":618,"y":144,"wires":[]},{"id":"39764e17.d151d2","type":"change","z":"66c49aa0.fcfbf4","name":"Prep Sonos Restore","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"data.entity_id","tot":"flow"},{"t":"set","p":"payload.data.with_group","pt":"msg","to":"data.with_group","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":1348,"y":432,"wires":[["b3774dc1.38335"]]},{"id":"b3774dc1.38335","type":"api-call-service","z":"66c49aa0.fcfbf4","name":"Sonos Restore","server":"6960f853.5a11b8","service_domain":"media_player","service":"sonos_restore","data":"","mergecontext":"","output_location":"payload","output_location_type":"msg","x":1568,"y":432,"wires":[[]]},{"id":"22f8bed6.68f6e2","type":"change","z":"66c49aa0.fcfbf4","name":"Set Online Again","rules":[{"t":"set","p":"payload","pt":"msg","to":"online","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1338,"y":384,"wires":[["7b8c4d45.01f2f4"]]},{"id":"7b8c4d45.01f2f4","type":"mqtt out","z":"66c49aa0.fcfbf4","name":"","topic":"hass/automation/speak/available","qos":"0","retain":"true","broker":"7c2cc3ae.eb8bac","x":1606,"y":384,"wires":[]},{"id":"baeb0db.5d7f4f","type":"subflow:66c49aa0.fcfbf4","z":"4df1ebb8.41e0d4","name":"","x":1466,"y":324,"wires":[]},{"id":"316e8332.0d811c","type":"poll-state","z":"f777b71b.223cb8","name":"Downstairs Bathroom Motion Sensor","server":"6960f853.5a11b8","updateinterval":"60","outputinitially":true,"outputonchanged":true,"entity_id":"binary_sensor.downstairs_bathroom_motion_sensor","state_type":"habool","halt_if":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"x":188,"y":86,"wires":[["82a50cae.d2ac4"]]},{"id":"82a50cae.d2ac4","type":"api-current-state","z":"f777b71b.223cb8","name":"Enabled?","server":"6960f853.5a11b8","outputs":2,"halt_if":"false","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.auto_downstairs_bathroom_enabled","state_type":"habool","override_payload":false,"override_data":false,"x":420,"y":86,"wires":[["ae4dbe3b.5e83"],[]],"outputLabels":["True","False"]},{"id":"ae4dbe3b.5e83","type":"subflow:4cf7b431.d9002c","z":"f777b71b.223cb8","name":"","x":592,"y":79,"wires":[]},{"id":"83c5b1.9af51a5","type":"poll-state","z":"f777b71b.223cb8","name":"Dining Room Motion Sensor","server":"6960f853.5a11b8","updateinterval":"60","outputinitially":true,"outputonchanged":true,"entity_id":"binary_sensor.dining_room_motion_sensor","state_type":"habool","halt_if":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"x":168,"y":220,"wires":[["ad0d31be.0ab1a"]]},{"id":"ad0d31be.0ab1a","type":"api-current-state","z":"f777b71b.223cb8","name":"Enabled?","server":"6960f853.5a11b8","outputs":2,"halt_if":"false","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.auto_dining_room_enabled","state_type":"habool","override_payload":false,"override_data":false,"x":420,"y":220,"wires":[["6f755f86.88856"],[]],"outputLabels":["True","False"]},{"id":"6f755f86.88856","type":"subflow:4cf7b431.d9002c","z":"f777b71b.223cb8","name":"","x":599,"y":213,"wires":[]},{"id":"867997d6.b91ad8","type":"poll-state","z":"f777b71b.223cb8","name":"Living Room Motion Sensor","server":"6960f853.5a11b8","updateinterval":"60","outputinitially":true,"outputonchanged":true,"entity_id":"binary_sensor.living_room_motion_sensor","state_type":"habool","halt_if":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"x":168,"y":336,"wires":[["f2e3bf5c.9a498"]]},{"id":"f2e3bf5c.9a498","type":"api-current-state","z":"f777b71b.223cb8","name":"Enabled?","server":"6960f853.5a11b8","outputs":2,"halt_if":"false","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.auto_living_room_enabled","state_type":"habool","override_payload":false,"override_data":false,"x":420,"y":336,"wires":[["d36ac750.0e4098"],[]],"outputLabels":["True","False"]},{"id":"d36ac750.0e4098","type":"subflow:4cf7b431.d9002c","z":"f777b71b.223cb8","name":"","x":596,"y":329,"wires":[]},{"id":"cd698bd9.f45ce8","type":"poll-state","z":"f777b71b.223cb8","name":"Upstairs Bathroom Motion Sensor","server":"6960f853.5a11b8","updateinterval":"60","outputinitially":true,"outputonchanged":true,"entity_id":"binary_sensor.upstairs_bathroom_motion_sensor","state_type":"habool","halt_if":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"x":178,"y":453,"wires":[["ad99ad67.8843d"]]},{"id":"ad99ad67.8843d","type":"api-current-state","z":"f777b71b.223cb8","name":"Enabled?","server":"6960f853.5a11b8","outputs":2,"halt_if":"false","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.auto_upstairs_bathroom_enabled","state_type":"habool","override_payload":false,"override_data":false,"x":420,"y":453,"wires":[["8ff9d5de.838c88"],[]],"outputLabels":["True","False"]},{"id":"8ff9d5de.838c88","type":"subflow:4cf7b431.d9002c","z":"f777b71b.223cb8","name":"","x":595,"y":446,"wires":[]},{"id":"f5a145b.65a1cb8","type":"poll-state","z":"f777b71b.223cb8","name":"Office Motion Sensor","server":"6960f853.5a11b8","updateinterval":"60","outputinitially":true,"outputonchanged":true,"entity_id":"binary_sensor.office_motion_sensor","state_type":"habool","halt_if":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"x":148,"y":565,"wires":[["81974802.e7fc58"]]},{"id":"81974802.e7fc58","type":"api-current-state","z":"f777b71b.223cb8","name":"Enabled?","server":"6960f853.5a11b8","outputs":2,"halt_if":"false","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.auto_office_enabled","state_type":"habool","override_payload":false,"override_data":false,"x":420,"y":565,"wires":[["4d77c188.283d7"],[]],"outputLabels":["True","False"]},{"id":"4d77c188.283d7","type":"subflow:4cf7b431.d9002c","z":"f777b71b.223cb8","name":"","x":594,"y":558,"wires":[]},{"id":"47843d17.8221a4","type":"poll-state","z":"f777b71b.223cb8","name":"Master Bedroom Motion Sensor","server":"6960f853.5a11b8","updateinterval":"60","outputinitially":true,"outputonchanged":true,"entity_id":"binary_sensor.master_bedroom_motion_sensor","state_type":"habool","halt_if":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"x":178,"y":681,"wires":[["27cc485b.5796f8"]]},{"id":"27cc485b.5796f8","type":"api-current-state","z":"f777b71b.223cb8","name":"Enabled?","server":"6960f853.5a11b8","outputs":2,"halt_if":"false","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.auto_master_bedroom_enabled","state_type":"habool","override_payload":false,"override_data":false,"x":420,"y":681,"wires":[["d0203761.00c3c8"],[]],"outputLabels":["True","False"]},{"id":"d0203761.00c3c8","type":"subflow:4cf7b431.d9002c","z":"f777b71b.223cb8","name":"","x":596,"y":674,"wires":[]},{"id":"902b2824.43c4d8","type":"api-call-service","z":"4cf7b431.d9002c","name":"Turn Off Light Group","server":"6960f853.5a11b8","service_domain":"homeassistant","service":"turn_off","data":"","mergecontext":"","output_location":"","output_location_type":"none","x":1691,"y":264,"wires":[[]]},{"id":"7cc17e00.3aa2e4","type":"switch","z":"4cf7b431.d9002c","name":"Is Light On?","property":"isLightOn","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1049,"y":264,"wires":[["1c482478.46842c"]]},{"id":"77475dae.f97d44","type":"switch","z":"4cf7b431.d9002c","name":"Automated?","property":"auto","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":586,"y":264,"wires":[["9c2d3623.e7bd28"]]},{"id":"c711bd99.681e6","type":"switch","z":"4cf7b431.d9002c","name":"Movement?","property":"data.state","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":382,"y":210,"wires":[["d6f8c303.6eb15"],["77475dae.f97d44"]],"outputLabels":["Movement Detected","No Movement Detected"]},{"id":"e7463eae.39c6c","type":"function","z":"4cf7b431.d9002c","name":"Define Variables","func":"var location = msg.data.entity_id.replace(\"binary_sensor.\",\"\").replace(\"_motion_sensor\",\"\");\n\nif (!(location + \"initialized\" in flow.keys)) {\n    flow.set(location + \"_location\", location);\n    var led_id = \"light.\" + location + \"_multisensor_led\"\n    flow.set(location + \"_led_id\", led_id);\n    var group_id = \"group.\" + location + \"_lights\";\n    flow.set(location + \"_group_id\", group_id);\n    var timer_id = \"timer.lighting_\" + location;\n    flow.set(location + \"_timer_id\", timer_id);\n\n    var hass = global.get(\"homeassistant\");\n    var ha = hass.homeAssistant;\n    var states = ha.states;\n    // check if there is a movement to light on relationship\n    if (timer_id in states) {\n        flow.set(location + \"_auto\",true);\n        var duration = states[timer_id].attributes[\"duration\"]; // format \"0:00:00\"\n        var a = duration.split(':');\n        // minutes are worth 60 seconds. Hours are worth 60 minutes.\n        var seconds = (+a[0]) * 3600 + (+a[1]) * 60 + (+a[2]);\n        var milliseconds = seconds * 1000\n        flow.set(location + \"_duration\", milliseconds)\n    } else {\n        flow.set(location + \"_auto\",false);\n        flow.set(location + \"_duration\", 0);\n    }\n    \n    // check if group exists\n    if (group_id in states) {\n        global.set(\"lighting.\" + location + \".group.id\", group_id);\n        global.set(\"lighting.\" + location + \".group.exists\", true);\n    } else {\n        global.set(\"lighting.\" + location + \".group.id\", group_id);\n        global.set(\"lighting.\" + location + \".group.exists\", false);\n    }\n\n    // check if there is a LED light on multisensor\n    if (led_id in states) {\n        flow.set(location+\"_led\",true);\n    } else {\n        flow.set(location+\"_led\",false);\n    }\n    flow.set(location+\"_initialized\",true);\n}\nmsg.location = location\nmsg.led_id = flow.get(location + \"_led_id\");\nmsg.group_id = flow.get(location + \"_group_id\");\nmsg.timer_id = flow.get(location + \"_timer_id\");\nmsg.duration = flow.get(location + \"_duration\");\nmsg.auto = flow.get(location + \"_auto\");\nmsg.initialized = flow.get(location + \"_initialized\");\nmsg.led = flow.get(location + \"_led\");\nif (global.get(\"lighting.\" + location + \".group.exists\")) {\n    msg.isLightOn = global.get(\"lighting.\" + location+\".group.state\");    \n} else {\n    msg.isLightOn = false;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":216,"wires":[["c711bd99.681e6"]]},{"id":"d6f8c303.6eb15","type":"switch","z":"4cf7b431.d9002c","name":"Automated?","property":"auto","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":586,"y":204,"wires":[["4fd46474.05b0fc"]]},{"id":"5e493ad5.8ce0b4","type":"switch","z":"4cf7b431.d9002c","name":"Is Light Off?","property":"isLightOn","propertyType":"msg","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":1078,"y":204,"wires":[["ee652014.60622"]]},{"id":"a836ed73.fea98","type":"api-call-service","z":"4cf7b431.d9002c","name":"Turn On Light Group","server":"6960f853.5a11b8","service_domain":"homeassistant","service":"turn_on","data":"","mergecontext":"","output_location":"payload","output_location_type":"msg","x":1451,"y":204,"wires":[[]]},{"id":"cf4a0c3e.55adc","type":"poll-state","z":"f777b71b.223cb8","name":"Downstairs Bathroom Lights","server":"6960f853.5a11b8","updateinterval":"60","outputinitially":true,"outputonchanged":true,"entity_id":"group.downstairs_bathroom_lights","state_type":"habool","halt_if":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"x":168,"y":134,"wires":[["5f41c09a.c61cd"]]},{"id":"5f41c09a.c61cd","type":"change","z":"f777b71b.223cb8","name":"Update","rules":[{"t":"set","p":"lighting.downstairs_bathroom.group.state","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":420,"y":134,"wires":[[]]},{"id":"22280b06.4b5e44","type":"poll-state","z":"f777b71b.223cb8","name":"Dining Room Lights","server":"6960f853.5a11b8","updateinterval":"60","outputinitially":true,"outputonchanged":true,"entity_id":"group.dining_room_lights","state_type":"habool","halt_if":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"x":138,"y":267,"wires":[["5e8e5303.68fffc"]]},{"id":"5e8e5303.68fffc","type":"change","z":"f777b71b.223cb8","name":"Update","rules":[{"t":"set","p":"lighting.dining_room.group.state","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":420,"y":267,"wires":[[]]},{"id":"d42d277a.c2ab08","type":"poll-state","z":"f777b71b.223cb8","name":"Upstairs Bathroom Lights","server":"6960f853.5a11b8","updateinterval":"60","outputinitially":true,"outputonchanged":true,"entity_id":"group.upstairs_bathroom_lights","state_type":"habool","halt_if":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"x":158,"y":501,"wires":[["c06cbbd4.9b1a98"]]},{"id":"c06cbbd4.9b1a98","type":"change","z":"f777b71b.223cb8","name":"Update","rules":[{"t":"set","p":"lighting.upstairs_bathroom.group.state","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":420,"y":501,"wires":[[]]},{"id":"b230f938.cdf738","type":"poll-state","z":"f777b71b.223cb8","name":"Office Lights","server":"6960f853.5a11b8","updateinterval":"60","outputinitially":true,"outputonchanged":true,"entity_id":"group.office_lights","state_type":"habool","halt_if":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"x":118,"y":613,"wires":[["c3d93740.276a58"]]},{"id":"c3d93740.276a58","type":"change","z":"f777b71b.223cb8","name":"Update","rules":[{"t":"set","p":"lighting.office.group.state","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":420,"y":613,"wires":[[]]},{"id":"e62f952f.a69838","type":"poll-state","z":"f777b71b.223cb8","name":"Master Bedroom Lights","server":"6960f853.5a11b8","updateinterval":"60","outputinitially":true,"outputonchanged":true,"entity_id":"group.master_bedroom_lights","state_type":"habool","halt_if":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"x":148,"y":729,"wires":[["5a2bf500.605c5c"]]},{"id":"5a2bf500.605c5c","type":"change","z":"f777b71b.223cb8","name":"Update","rules":[{"t":"set","p":"lighting.master_bedroom.group.state","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":420,"y":729,"wires":[[]]},{"id":"8714deab.b78c1","type":"poll-state","z":"21c55085.5e8c","name":"Downstairs Bathroom Motion Sensor","server":"6960f853.5a11b8","updateinterval":"60","outputinitially":true,"outputonchanged":true,"entity_id":"binary_sensor.downstairs_bathroom_motion_sensor","state_type":"habool","halt_if":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"x":176,"y":84,"wires":[["994109d7.b95a78"]]},{"id":"994109d7.b95a78","type":"api-current-state","z":"21c55085.5e8c","name":"Enabled?","server":"6960f853.5a11b8","outputs":2,"halt_if":"false","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.auto_downstairs_bathroom_enabled","state_type":"habool","override_payload":false,"override_data":false,"x":408,"y":84,"wires":[["1280f975.d5e8c7"],[]],"outputLabels":["True","False"]},{"id":"f4cbaf65.64429","type":"change","z":"21c55085.5e8c","name":"Set Light Group","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"group_id","tot":"msg"},{"t":"set","p":"payload.domain","pt":"msg","to":"homeassistant","tot":"str"},{"t":"set","p":"payload.service","pt":"msg","to":"turn_off","tot":"str"},{"t":"set","p":"payload.entity_id","pt":"msg","to":"group_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1616,"y":235,"wires":[["c353041b.26acc8"]]},{"id":"c353041b.26acc8","type":"api-call-service","z":"21c55085.5e8c","name":"Turn Off Light Group","server":"6960f853.5a11b8","service_domain":"homeassistant","service":"turn_off","data":"","mergecontext":"","output_location":"","output_location_type":"none","x":1816,"y":235,"wires":[[]]},{"id":"367c0804.92f4f8","type":"switch","z":"21c55085.5e8c","name":"Turn Off?","property":"payload","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1452,"y":235,"wires":[["f4cbaf65.64429"]]},{"id":"e3eb102d.a4e24","type":"function","z":"21c55085.5e8c","name":"Threshold","func":"var thresh = (msg.data.timeSinceChangedMs > msg.duration) ? true:false;\nmsg.payload = thresh;\n// var newMsg = { payload: thresh };\nreturn msg;","outputs":1,"noerr":0,"x":1305,"y":235,"wires":[["367c0804.92f4f8"]]},{"id":"eb0b9b7.40e6168","type":"switch","z":"21c55085.5e8c","name":"Is Light On?","property":"isLightOn","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1145,"y":235,"wires":[["e3eb102d.a4e24"]]},{"id":"be8068a7.f8eeb8","type":"switch","z":"21c55085.5e8c","name":"Automated?","property":"auto","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":982,"y":235,"wires":[["eb0b9b7.40e6168"]]},{"id":"1674f14d.727bdf","type":"switch","z":"21c55085.5e8c","name":"Movement?","property":"data.state","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":778,"y":181,"wires":[["7957348e.4d5dbc"],["be8068a7.f8eeb8"]],"outputLabels":["Movement Detected","No Movement Detected"]},{"id":"1280f975.d5e8c7","type":"function","z":"21c55085.5e8c","name":"Define Variables","func":"var location = msg.data.entity_id.replace(\"binary_sensor.\",\"\").replace(\"_motion_sensor\",\"\");\n\nif (!(location + \"initialized\" in flow.keys)) {\n    flow.set(location + \"_location\", location);\n    var led_id = \"light.\" + location + \"_multisensor_led\"\n    flow.set(location + \"_led_id\", led_id);\n    var group_id = \"group.\" + location + \"_lights\";\n    flow.set(location + \"_group_id\", group_id);\n    var timer_id = \"timer.lighting_\" + location;\n    flow.set(location + \"_timer_id\", timer_id);\n\n    var hass = global.get(\"homeassistant\");\n    var ha = hass.homeAssistant;\n    var states = ha.states;\n    // check if there is a movement to light on relationship\n    if (timer_id in states) {\n        flow.set(location + \"_auto\",true);\n        var duration = states[timer_id].attributes[\"duration\"]; // format \"0:00:00\"\n        var a = duration.split(':');\n        // minutes are worth 60 seconds. Hours are worth 60 minutes.\n        var seconds = (+a[0]) * 3600 + (+a[1]) * 60 + (+a[2]);\n        var milliseconds = seconds * 1000\n        flow.set(location + \"_duration\", milliseconds)\n        if (group_id in states) {\n            global.set(\"lighting.\" + location + \".group.id\", group_id);\n            global.set(\"lighting.\" + location + \".group.exists\", true);\n        }\n    } else {\n        flow.set(location + \"_auto\",false);\n        flow.set(location + \"_duration\", 0);\n    }\n    // check if there is a LED light on multisensor\n    if (led_id in states) {\n        flow.set(location+\"_led\",true);\n    } else {\n        flow.set(location+\"_led\",false);\n    }\n    flow.set(location+\"_initialized\",true);\n}\nmsg.location = location\nmsg.led_id = flow.get(location + \"_led_id\");\nmsg.group_id = flow.get(location + \"_group_id\");\nmsg.timer_id = flow.get(location + \"_timer_id\");\nmsg.duration = flow.get(location + \"_duration\");\nmsg.auto = flow.get(location + \"_auto\");\nmsg.initialized = flow.get(location + \"_initialized\");\nmsg.led = flow.get(location + \"_led\");\nmsg.isLightOn = global.get(\"lighting.\" + location+\".group.state\")||false;\nreturn msg;","outputs":1,"noerr":0,"x":596,"y":84,"wires":[["1674f14d.727bdf"]]},{"id":"7957348e.4d5dbc","type":"switch","z":"21c55085.5e8c","name":"Automated?","property":"auto","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":982,"y":175,"wires":[["683b5479.4949bc"]]},{"id":"683b5479.4949bc","type":"switch","z":"21c55085.5e8c","name":"Is Light Off?","property":"isLightOn","propertyType":"msg","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":1143,"y":175,"wires":[["2aa60c78.6a2244"]]},{"id":"2aa60c78.6a2244","type":"change","z":"21c55085.5e8c","name":"Set Light Group","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"group_id","tot":"msg"},{"t":"set","p":"payload.domain","pt":"msg","to":"homeassistant","tot":"str"},{"t":"set","p":"payload.service","pt":"msg","to":"turn_on","tot":"str"},{"t":"set","p":"payload.entity_id","pt":"msg","to":"group_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1309,"y":175,"wires":[["15a98caf.544233"]]},{"id":"15a98caf.544233","type":"api-call-service","z":"21c55085.5e8c","name":"Turn On Light Group","server":"6960f853.5a11b8","service_domain":"homeassistant","service":"turn_on","data":"","mergecontext":"","output_location":"payload","output_location_type":"msg","x":1509,"y":175,"wires":[[]]},{"id":"a10b6fb1.1816f","type":"change","z":"21c55085.5e8c","name":"Update","rules":[{"t":"set","p":"lighting.downstairs_bathroom.group.state","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":408,"y":204,"wires":[[]]},{"id":"d8522e3e.2c81f","type":"poll-state","z":"21c55085.5e8c","name":"Downstairs Bathroom Lights","server":"6960f853.5a11b8","updateinterval":"60","outputinitially":true,"outputonchanged":true,"entity_id":"group.downstairs_bathroom_lights","state_type":"habool","halt_if":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"x":156,"y":204,"wires":[["a10b6fb1.1816f"]]},{"id":"7738dea.60bbc2","type":"inject","z":"21c55085.5e8c","name":"Turn On","topic":"","payload":"{\"payload\":{\"entity_id\":\"light.living_room_multisensor_led\",\"data\":{\"entity_id\":\"light.living_room_multisensor_led\",\"rgb_color\":\"[0,255,255]\"},\"domain\":\"light\",\"service\":\"turn_on\"}}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":576,"y":396,"wires":[["c22e32b8.92c7a"]]},{"id":"c22e32b8.92c7a","type":"api-call-service","z":"21c55085.5e8c","name":"","server":"6960f853.5a11b8","service_domain":"light","service":"turn_on","data":"","mergecontext":"","output_location":"payload","output_location_type":"msg","x":796,"y":396,"wires":[[]]},{"id":"166a39ae.4c5446","type":"inject","z":"21c55085.5e8c","name":"Turn Off","topic":"","payload":"{\"payload\":{\"entity_id\":\"light.living_room_multisensor_led\",\"data\":{\"entity_id\":\"light.living_room_multisensor_led\"},\"domain\":\"light\",\"service\":\"turn_off\"}}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":576,"y":456,"wires":[["41656c6d.05eb04"]]},{"id":"41656c6d.05eb04","type":"api-call-service","z":"21c55085.5e8c","name":"","server":"6960f853.5a11b8","service_domain":"light","service":"turn_off","data":"","mergecontext":"","output_location":"payload","output_location_type":"msg","x":796,"y":456,"wires":[[]]},{"id":"b5c4ab20.22dc58","type":"api-call-service","z":"47459c8.4133064","name":"Turn On LED","server":"6960f853.5a11b8","service_domain":"light","service":"turn_on","data":"","mergecontext":"","output_location":"payload","output_location_type":"msg","x":397,"y":299,"wires":[["ed675082.07133"]]},{"id":"ed675082.07133","type":"delay","z":"47459c8.4133064","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":555,"y":299,"wires":[["c4d8076.87ff7f8"]]},{"id":"dbe0ed06.aa94f","type":"api-call-service","z":"47459c8.4133064","name":"Turn Off LED","server":"6960f853.5a11b8","service_domain":"light","service":"turn_off","data":"","mergecontext":"","output_location":"payload","output_location_type":"msg","x":925,"y":299,"wires":[[]]},{"id":"c4d8076.87ff7f8","type":"change","z":"47459c8.4133064","name":"Set Light Turn Off","rules":[{"t":"delete","p":"payload.data","pt":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"led_id","tot":"msg"},{"t":"set","p":"payload.entity_id","pt":"msg","to":"led_id","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":729,"y":299,"wires":[["dbe0ed06.aa94f"]]},{"id":"ee652014.60622","type":"change","z":"4cf7b431.d9002c","name":"Set Light Group","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"group_id","tot":"msg"},{"t":"set","p":"payload.domain","pt":"msg","to":"homeassistant","tot":"str"},{"t":"set","p":"payload.service","pt":"msg","to":"turn_on","tot":"str"},{"t":"set","p":"payload.entity_id","pt":"msg","to":"group_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1251,"y":204,"wires":[["a836ed73.fea98"]]},{"id":"34458585.57ee1a","type":"change","z":"4cf7b431.d9002c","name":"Set Light Group","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"group_id","tot":"msg"},{"t":"set","p":"payload.domain","pt":"msg","to":"homeassistant","tot":"str"},{"t":"set","p":"payload.service","pt":"msg","to":"turn_off","tot":"str"},{"t":"set","p":"payload.entity_id","pt":"msg","to":"group_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1508,"y":264,"wires":[["902b2824.43c4d8"]]},{"id":"13bcd428.152a2c","type":"switch","z":"4cf7b431.d9002c","name":"Turn Off?","property":"payload","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1344,"y":264,"wires":[["34458585.57ee1a"]]},{"id":"1c482478.46842c","type":"function","z":"4cf7b431.d9002c","name":"Threshold","func":"var thresh = (msg.data.timeSinceChangedMs > msg.duration) ? true:false;\nmsg.payload = thresh;\n// var newMsg = { payload: thresh };\nreturn msg;","outputs":1,"noerr":0,"x":1200,"y":264,"wires":[["13bcd428.152a2c"]]},{"id":"9c2d3623.e7bd28","type":"function","z":"4cf7b431.d9002c","name":"Light Exists","func":"msg.payload = global.get(\"lighting.\" + msg.location + \".exists\");\nreturn msg;","outputs":1,"noerr":0,"x":742,"y":264,"wires":[["c6ef9dc5.4e475"]]},{"id":"c6ef9dc5.4e475","type":"switch","z":"4cf7b431.d9002c","name":"Light Exists?","property":"payload","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":886,"y":264,"wires":[["7cc17e00.3aa2e4"]]},{"id":"4fd46474.05b0fc","type":"function","z":"4cf7b431.d9002c","name":"Light Exists","func":"msg.payload = global.get(\"lighting.\" + msg.location + \".exists\");\nreturn msg;","outputs":1,"noerr":0,"x":754,"y":204,"wires":[["2f9166b3.99789a"]]},{"id":"2f9166b3.99789a","type":"switch","z":"4cf7b431.d9002c","name":"Light Exists?","property":"payload","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":910,"y":204,"wires":[["5e493ad5.8ce0b4"]]},{"id":"70b0467a.9c1f18","type":"change","z":"47459c8.4133064","name":"Set Light Turn On","rules":[{"t":"delete","p":"payload.data","pt":"msg"},{"t":"delete","p":"data","pt":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"led_id","tot":"msg"},{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"[0,255,255]","tot":"str"},{"t":"set","p":"payload.entity_id","pt":"msg","to":"led_id","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":186,"y":300,"wires":[["b5c4ab20.22dc58"]]}]